<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="AI-driven kundtjänst och ärendehantering med inbyggd CRM" />
  <title>AI Kundtjänst</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="style.css" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body data-theme="dark">

  <div class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="brand">
          <div class="logo"><i class="fa-solid fa-headset"></i></div>
          <div class="brand-text">
            <h1 class="brand-title">AI Kundtjänst</h1>
            <div class="brand-subtitle" id="roleBadge">Inte inloggad</div>
          </div>
        </div>
        <button class="btn icon-btn close-sidebar" id="closeSidebarBtn" aria-label="Stäng meny">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="sidebar-content">
        <div class="sidebar-block">
          <label for="categorySelect" class="label">Företag / Kategori</label>
          <select id="categorySelect" class="input">
            <option value="demo">Demo AB</option>
            <!-- fylls dynamiskt via JS -->
          </select>
        </div>

        <nav class="menu" aria-label="Huvudmeny">
          <button class="menu-item active" id="openChatView" data-view="chatView">
            <i class="fa-solid fa-comments"></i> Chatt
          </button>
          <button class="menu-item" id="openMyTicketsView" data-view="myTicketsView">
            <i class="fa-solid fa-ticket"></i> Mina ärenden
          </button>
          <button class="menu-item agent-only" id="openCustomersView" data-view="customersView" style="display:none;">
            <i class="fa-solid fa-users"></i> Kundbas
          </button>
          <button class="menu-item agent-only" id="openInboxView" data-view="inboxView" style="display:none;">
            <i class="fa-solid fa-inbox"></i> Inbox
            <span id="inboxNotifDot" class="notif-dot" style="display:none;"></span>
          </button>
          <button class="menu-item agent-only" id="openSlaView" data-view="slaView" style="display:none;">
            <i class="fa-solid fa-chart-line"></i> SLA & KPI
          </button>
          <button class="menu-item admin-only" id="openAdminView" data-view="adminView" style="display:none;">
            <i class="fa-solid fa-shield-halved"></i> Admin
          </button>
          <button class="menu-item" id="openSettingsView" data-view="settingsView" style="display:none;">
            <i class="fa-solid fa-gear"></i> Inställningar
          </button>
        </nav>

        <div class="sidebar-footer">
          <button id="themeToggle" class="btn ghost full" aria-label="Byt tema">
            <i class="fa-solid fa-moon"></i> Ljust / Mörkt
          </button>
          <button id="logoutBtn" class="btn danger full" style="display:none;">
            <i class="fa-solid fa-right-from-bracket"></i> Logga ut
          </button>
          <button id="toggleDebugBtn" class="btn ghost full">
            <i class="fa-solid fa-bug"></i> Debug
          </button>
        </div>

        <div id="debugPanel" class="debug-panel" style="display:none;">
          <div><strong>API:</strong> <span id="dbgApi">-</span></div>
          <div><strong>Inloggad:</strong> <span id="dbgLogged">-</span></div>
          <div><strong>Roll:</strong> <span id="dbgRole">-</span></div>
          <div><strong>Ticket:</strong> <span id="dbgTicket">-</span></div>
          <div><strong>Kund:</strong> <span id="dbgCustomer">-</span></div>
          <div><strong>RAG:</strong> <span id="dbgRag">-</span></div>
        </div>
      </div>
    </aside>

    <!-- HUVUDINNEHÅLL -->
    <main class="main">

      <button class="btn icon-btn mobile-menu-btn" id="openSidebarBtn" aria-label="Öppna meny">
        <i class="fa-solid fa-bars"></i>
      </button>

      <div id="toastContainer" class="toast-container"></div>

      <!-- 1. Inloggning -->
      <section id="authView" class="view active">
        <div class="auth-wrapper">
          <div class="card auth-card">
            <h2>Logga in</h2>
            <p class="muted">Logga in för att använda chatten och hantera ärenden.</p>

            <form id="loginForm">
              <div class="form-group">
                <label for="username">Användarnamn</label>
                <input id="username" class="input" placeholder="t.ex. leo123" required autocomplete="username" />
              </div>

              <div class="form-group">
                <label for="password">Lösenord</label>
                <div class="password-wrapper">
                  <input id="password" type="password" class="input" placeholder="••••••••" required autocomplete="current-password" />
                  <button type="button" class="btn icon-btn toggle-password" id="togglePassBtn" aria-label="Visa/dölj lösenord">
                    <i class="fa-solid fa-eye"></i>
                  </button>
                </div>
              </div>

              <div class="form-actions">
                <button id="loginBtn" class="btn primary" type="submit">Logga in</button>
                <button id="registerBtn" class="btn secondary" type="button">Skapa konto</button>
              </div>

              <button id="openForgotBtn" class="btn text-btn" type="button">Glömt lösenord?</button>

              <div id="authMessage" class="alert" role="alert" style="display:none;"></div>
            </form>
          </div>

          <!-- Glömt lösenord & Återställ -->
          <div id="forgotCard" class="card auth-card" style="display:none;">
            <h2>Återställ lösenord</h2>
            <p class="muted">Ange din e-post så skickas en återställningslänk.</p>
            <input id="forgotEmail" class="input" placeholder="din@email.se" type="email" />
            <div class="form-actions">
              <button id="sendForgotBtn" class="btn primary">Skicka länk</button>
              <button id="closeForgotBtn" class="btn ghost">Avbryt</button>
            </div>
            <div id="forgotMsg" class="alert" style="display:none;"></div>
          </div>

          <div id="resetCard" class="card auth-card" style="display:none;">
            <h2>Ange nytt lösenord</h2>
            <div class="password-wrapper">
              <input id="resetNewPass" type="password" class="input" placeholder="Nytt lösenord" />
              <button type="button" class="btn icon-btn toggle-password" id="toggleResetPassBtn" aria-label="Visa/dölj lösenord">
                <i class="fa-solid fa-eye"></i>
              </button>
            </div>
            <button id="resetSaveBtn" class="btn primary full" style="margin-top:16px;">Spara nytt lösenord</button>
            <div id="resetMsg" class="alert" style="display:none;"></div>
          </div>
        </div>
      </section>

      <!-- 2. Chatt -->
      <section id="chatView" class="view" hidden>
        <div class="topbar">
          <div>
            <h2 id="chatTitle">AI Kundtjänst</h2>
            <p id="chatSubtitle" class="muted">Ställ en fråga så hjälper jag dig direkt.</p>
          </div>
          <div class="topbar-actions">
            <button id="newTicketBtn" class="btn ghost"><i class="fa-solid fa-circle-plus"></i> Nytt ärende</button>
            <button id="clearChatBtn" class="btn ghost"><i class="fa-solid fa-trash"></i> Rensa</button>
            <button id="exportChatBtn" class="btn ghost"><i class="fa-solid fa-download"></i> Export</button>
          </div>
        </div>

        <div class="chat-meta-row">
          <label for="chatCustomerSelect">Koppla till kund:</label>
          <select id="chatCustomerSelect" class="input">
            <option value="">Ingen kund vald</option>
          </select>
        </div>

        <div id="messages" class="messages"></div>

        <div class="composer">
          <input id="messageInput" class="input" placeholder="Skriv ditt meddelande..." autocomplete="off" />
          <button id="sendBtn" class="btn primary round"><i class="fa-solid fa-paper-plane"></i></button>
        </div>

        <div class="feedbackRow">
          <button id="fbUp" class="btn ghost small"><i class="fa-solid fa-thumbs-up"></i> Bra</button>
          <button id="fbDown" class="btn ghost small"><i class="fa-solid fa-thumbs-down"></i> Dåligt</button>
          <span id="fbMsg" class="muted small"></span>
        </div>
      </section>

      <!-- 3. Kundbas (NY) -->
      <section id="customersView" class="view" hidden>
        <div class="topbar">
          <div>
            <h2>Kundbas / CRM</h2>
            <p class="muted">Hantera kunder och koppla dem till ärenden</p>
          </div>
          <div class="topbar-actions">
            <button id="newCustomerBtn" class="btn primary"><i class="fa-solid fa-user-plus"></i> Ny kund</button>
            <button id="customersRefreshBtn" class="btn ghost"><i class="fa-solid fa-rotate"></i> Uppdatera</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-head">
            <h3>Kunder</h3>
            <input id="customerSearchInput" class="input search-input" placeholder="Sök på namn, orgnr, e-post..." />
          </div>
          <div id="customersList" class="list customers-list"></div>
        </div>

        <!-- Modal för skapa / redigera kund -->
        <dialog id="customerModal" class="modal">
          <div class="modal-content">
            <h3 id="customerModalTitle">Ny kund</h3>
            <form id="customerForm">
              <div class="form-grid-2">
                <div class="form-group">
                  <label for="custCompanyName">Företagsnamn *</label>
                  <input id="custCompanyName" class="input" required />
                </div>
                <div class="form-group">
                  <label for="custOrgNumber">Organisationsnummer</label>
                  <input id="custOrgNumber" class="input" pattern="\d{6}-\d{4}|\d{10}" placeholder="ÅÅÅÅMMDD-XXXX" />
                </div>
              </div>

              <div class="form-group">
                <label for="custAddress">Adress</label>
                <input id="custAddress" class="input" placeholder="Gatan 12, 123 45 Ort" />
              </div>

              <div class="form-grid-2">
                <div class="form-group">
                  <label for="custContactPerson">Kontaktperson</label>
                  <input id="custContactPerson" class="input" />
                </div>
                <div class="form-group">
                  <label for="custEmail">E-post</label>
                  <input id="custEmail" type="email" class="input" />
                </div>
              </div>

              <div class="form-group">
                <label for="custPhone">Telefon</label>
                <input id="custPhone" class="input" placeholder="+46 ..." />
              </div>

              <div class="form-group">
                <label for="custStatus">Status</label>
                <select id="custStatus" class="input">
                  <option value="active">Aktiv</option>
                  <option value="inactive">Inaktiv</option>
                  <option value="prospect">Prospekt</option>
                </select>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn primary">Spara kund</button>
                <button type="button" class="btn ghost" onclick="document.getElementById('customerModal').close()">Avbryt</button>
              </div>
            </form>
          </div>
        </dialog>
      </section>

      <!-- Dina befintliga andra sektioner (myTicketsView, inboxView, slaView, adminView, settingsView) -->
      <!-- Lägg in dem här som tidigare, eller utöka med kundinfo där det behövs -->

    </main>
  </div>

  <script src="script.js"></script>
</body>
</html>